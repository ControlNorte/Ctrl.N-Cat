{% extends 'base.html' %}
{% load custom_filters %}

{% block titulo %}
Financeiro | {{ dadoscliente }}
{% endblock %}

{% block head %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<style>
    .wrapper2 section {
        display: none;
    }
    .wrapper2 section:first-child {
        display: block;
    }
    .selectconci {
    color: #4f4f4f !important;  /* Certifique-se de que este seja o estilo desejado */
    width: 150px;
    height: 40px;
    border-radius: 6px;
    display: inline-block;    /* Se for um elemento de linha, certifique-se de que se comporta como esperado */
    }
    input[type="number"] {
            text-align: right;
            padding-right: 10px;
        }
</style>
{% endblock %}

{% block content %}
<main class="py-20 px-10">

    <div class="flex felx-nowrap justify-between items-center pt-4 pb-3 px-4">
        <div class="text-3xl text-violet-900 flex justify-between">{{ dadoscliente }}</div>
        <a href="{% url 'financeiro:maisopicoes' %}">
            <div class="text-lg text-violet-900 flex justify-between items-center">
                <ion-icon name="ellipsis-vertical-sharp"></ion-icon> Mais opções
            </div>
        </a>
    </div>

    <div id="movimentacaosection">

        <div class=" container pt-2 px-20 flex justify-between">
            <div class="text-lg text-violet-900 hover:border-b-4 border-violet-300 p-2"><a
                    href="{% url 'financeiro:financeirocliente' dadoscliente.pk %}">Resumo</a></div>
            <div class="text-lg text-violet-900 border-b-4 border-violet-800 p-2"><a
                    href="{% url 'financeiro:caixa' %}">Caixa</a></div>
            <div class="text-lg text-violet-900 hover:border-b-4 border-violet-300 p-2"><a
                    href="{% url 'financeiro:dre' %}">DRE</a></div>
            <div class="text-lg text-violet-900 hover:border-b-4 border-violet-300 p-2"><a
                    href="{% url 'financeiro:dashboard' %}">Dashboard</a></div>
            <div class="text-lg text-violet-900 hover:border-b-4 border-violet-300 p-2"><a
                    href="{% url 'financeiro:orcamento' %}">Orçamento</a></div>
            <div class="text-lg text-violet-900 hover:border-b-4 border-violet-300 p-2"><a
                    href="{% url 'financeiro:contas' %}">Pagos e Recebido</a></div>
        </div>

        <hr>

        <div class="container flex flex-nowrap pt-4 px-2 gap-2">
            <div class="h-96 w-10/12 bg-violet-100 font-semibold text-lg text-violet-700 text-center">
                <div class="flex flex-nowrap justify-between p-2">
                    <div>Fluxo de Caixa</div>
                    <div>
                        <form method="post">
                            {% csrf_token %}
                            <input type="hidden" value="mes" name='tipo'>
                            <select class="bg-violet-100 hover:bg-violet-300" name="mesfiltro">
                                <option>{{ mesatual }}</option>
                                <option>Jan</option>
                                <option>Fev</option>
                                <option>Mar</option>
                                <option>Abr</option>
                                <option>Mai</option>
                                <option>Jun</option>
                                <option>Jul</option>
                                <option>Ago</option>
                                <option>Set</option>
                                <option>Out</option>
                                <option>Nov</option>
                                <option>Dez</option>
                            </select>
                            <button type="submit"> > </button>
                        </form>
                    </div>
                </div>
                {% if grafico %}
                {{ grafico|safe }}
                {% else %}
                <p>Não há dados para exibir o gráfico.</p>
                {% endif %}
            </div>

            <div class=" w-2/12">
                <div class="h-96 bg-violet-100 hover:bg-violet-300">

                    <div class="font-semibold text-lg text-violet-700 text-center"><a
                            href="{% url 'financeiro:banco' %}">
                            Bancos
                        </a></div>

                    {% for banco in bancos %}
                    <p class="text-violet-700 px-2">
                        <a href="{% url 'financeiro:movimentacao' banco.banco %}">{{ banco.banco }}</a>
                    </p>
                    {% endfor %}

                </div>
            </div>
        </div>

        <hr>

        <div>
            Colocar contas a pagar e receber
        </div>

    </div>

    
<script>
    function formatValue(input) {
            let value = input.value.replace(/\D/g, ''); // Remove qualquer coisa que não seja número
            value = (value / 100).toFixed(2); // Converte para número decimal com 2 casas
            input.value = value.replace('.', ','); // Substitui ponto por vírgula
        }

    document.addEventListener('DOMContentLoaded', (event) => {
        function showSection(form, sectionId) {
            form.querySelectorAll('section').forEach((section) => {
                section.style.display = section.id === sectionId ? 'block' : 'none';
            });
        }

        document.querySelectorAll('.dataForm').forEach((form) => {
            form.querySelectorAll('a[href="#movi"]').forEach((link) => {
                link.addEventListener('click', (event) => {
                    event.preventDefault();
                    const formId = link.getAttribute('data-form-id');
                    showSection(form, 'movi-' + formId);
                });
            });

            form.querySelectorAll('a[href="#transf"]').forEach((link) => {
                link.addEventListener('click', (event) => {
                    event.preventDefault();
                    const formId = link.getAttribute('data-form-id');
                    showSection(form, 'transf-' + formId);
                });
            });
        });
    });
    function handleFormSubmission(button, url) {
        const form = button.closest('form');
        form.style.display = 'none'; // Hide the form immediately

        const formData = new FormData(form);
        const csrftoken = formData.get('csrfmiddlewaretoken');

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
            },
            body: formData,
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const savedDataDiv = document.createElement('div');
                    savedDataDiv.classList.add('savedData');
                    savedDataDiv.innerHTML = `
                        <p>Data: ${formData.get('data')}</p>
                        <p>Descrição: ${formData.get('descricao')}</p>
                        <p>Categoria: ${formData.get('categoria')}</p>
                        <p>Sub-Categoria: ${formData.get('subcategoria')}</p>
                        <p>Detalhes: ${formData.get('detalhe')}</p>
                        <p>Centro de Custo: ${formData.get('centrocusto')}</p>
                        <p>Valor: ${formData.get('valor')}</p>
                        ${url.includes('transf') ? `<p>Banco Destino: ${formData.get('bancodestino')}</p>` : ''}
                    `;

                    if (url.includes('transf') || url.includes('save_data_url_rule')) {
                        document.getElementById('savedDataContainer').appendChild(savedDataDiv);
                    } else {
                        form.parentElement.appendChild(savedDataDiv); // Append to the same parent as the form
                    }
                } else {
                    alert('Erro ao salvar os dados');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }

    document.querySelectorAll('.saveBtn').forEach(button => {
        button.addEventListener('click', () => handleFormSubmission(button, "{% url 'financeiro:save_data_url' %}"));
    });

    document.querySelectorAll('.ruleBtn').forEach(button => {
        button.addEventListener('click', () => handleFormSubmission(button, "{% url 'financeiro:save_data_url_rule' %}"));
    });

    document.querySelectorAll('.transfBtn').forEach(button => {
        button.addEventListener('click', () => handleFormSubmission(button, "{% url 'financeiro:transf' %}"));
    });

    document.querySelectorAll('.deleteBtn').forEach(button => {
        button.addEventListener('click', () => handleFormSubmission(button, "{% url 'financeiro:delete' %}"))
        button.addEventListener('click', function () {
            const form = button.closest('form');
            form.style.display = 'none';
        });
    });

    const descricaoInput = document.getElementById('descricaoInput');

    descricaoInput.addEventListener('input', function() {
        this.setAttribute('value', this.value);
    });
</script>
</main>
{% endblock %}